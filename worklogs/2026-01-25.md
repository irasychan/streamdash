# Work Log - January 25, 2026

## Summary
Completed architecture refactor with feature-based directory structure and Zustand state management. Fixed widget transparent backgrounds and URL parameter handling. Redesigned settings page with Monkeytype-inspired minimal UI. Added local message hiding feature for chat moderation.

---

## Completed Tasks

### Architecture Separation of Concerns
**Priority:** Medium

Migrated to feature-based architecture with clear separation of concerns.

**Final Directory Structure:**
```
features/               # Feature modules (top-level)
├── chat/
│   ├── components/     # ChatContainer, ChatMessage, ConnectionStatus, PlatformBadge
│   ├── hooks/          # useChatStatus
│   ├── types/          # ChatMessage, ChatPlatform, etc.
│   └── utils/          # emoteRenderer, youtubeTokenStore
├── emotes/
│   ├── hooks/          # useEmotes, useAutoLoadEmotes
│   └── types/          # ThirdPartyEmote, EmoteSource
├── config/
│   ├── useConfig.ts    # Client hook
│   └── types.ts        # StreamDashConfig schema
├── preferences/
│   ├── usePreferences.ts  # Client hook with theme application
│   └── types.ts           # UserPreferences, theme presets
├── widgets/
│   └── components/     # WidgetConfigCard, ChatWidgetConfigForm
└── dashboard/
    └── hooks/          # useDashboardStatus

services/               # External API clients (top-level, no React)
├── chat/
│   ├── ConnectionManager.ts
│   └── bridges/        # TwitchIRC, YouTubePoller, DiscordBridge
├── discord/
│   └── auth.ts
├── emotes/
│   └── thirdPartyEmotes.ts
└── widgets/
    └── urlGenerator.ts

state/                  # Zustand stores (top-level)
└── appStore.ts

server/                 # Server-only logic (top-level)
└── config.ts           # Config persistence

components/
├── layout/             # AppSidebar, DashboardHeader, DashboardLayoutClient
├── ui/                 # shadcn/ui primitives
└── [shared]/           # StatCard, DiscordChannelPicker

lib/                    # Cross-cutting utilities
└── shared/utils/cn.ts
```

**Subtasks Completed:**
- Mapped current folders/files to proposed layers
- Decided target structure (`features/`, `services/`, `state/`, `server/`)
- Identified quick wins (move low-risk modules first)
- Drafted migration steps for contexts → store(s)
- Updated import paths and aliases as needed
- Removed backwards-compatible re-exports after migration
- Moved feature UI components into feature modules
- Created components/layout/ for shared layout components
- Extracted services to top-level `services/`
- Moved state to top-level `state/`
- Created `server/` for server-only logic
- Verified build passes

---

### State Management Refactor
**Priority:** Medium

Reduced context provider nesting by migrating to Zustand.

**What was done:**
- Created `lib/state/appStore.ts` with Zustand store containing slices for:
  - Dashboard status (status string, isLive flag)
  - Chat status (connection state, polling, Twitch user lookup)
  - Emotes (third-party emotes with localStorage persistence)
- Created wrapper hooks: `useChatStatus`, `useDashboardStatus`, `useEmotes`
- Removed `ChatStatusContext` and `DashboardStatusContext`
- Removed provider nesting from `dashboard-layout-client.tsx`
- Preferences already use provider-free `useSyncExternalStore` pattern

**Subtasks Completed:**
- Documented research findings (`docs/research-state-management-refactor.md`)
- Audited current context providers and their dependencies
- Chose state management approach (Zustand)
- Migrated chat status state
- Migrated emote state
- Preferences state (already provider-free, no migration needed)
- Removed provider nesting from layouts
- Tested SSR compatibility (build passes)

---

### Widget Transparent Background Fix
**Priority:** Medium

Widget backgrounds are now transparent when loaded as OBS browser sources with `?transparent=true`.

**What was done:**
- Created `app/widgets/layout.tsx` - Applies transparent body styles when `transparent=true` param is set
- Added `.widget-transparent` CSS class in `globals.css` to override body background and `::before` gradient
- Updated all widget pages (chat, goal, stats) to support `transparent=true` URL param
- When transparent: removes Card backgrounds/borders/shadows, removes main padding

**Usage:**
```
/widgets/chat?transparent=true&twitchChannel=yourChannel
/widgets/goal?transparent=true&channel=yourChannel
/widgets/stats?transparent=true&channel=yourChannel
```

---

### Widget URL Param & Config Fixes
**Priority:** Medium

Fixed widget configuration URL generation and param handling.

**What was done:**
- Added `messageDensity` (Message Spacing) option to chat widget config
- Fixed `showAvatars` default mismatch between widget config (`false`) and ChatMessage fallback
- Updated chat widget page to read all display prefs from URL: `fontSize`, `messageDensity`, `showAvatars`, `showBadges`
- Fixed Tailwind config to scan `features/` directory (platform badge colors were being purged)
- Fixed Select component dropdown background (was transparent, now solid)

**URL params now supported:**
```
/widgets/chat?fontSize=small&messageDensity=compact&showAvatars=true&showBadges=false&transparent=true
```

---

### Settings Page Redesign
**Priority:** Low

Redesigned settings page with Monkeytype-inspired minimal UI.

**What was done:**
- Removed Appearance section (preferences now per-widget via URL params)
- Created collapsible Section component with chevron icons
- Created SettingRow component (label + description left, controls right)
- Created PillButton component for save/reset actions
- Sections: twitch, youtube, discord, goals, environment (collapsed), danger zone (collapsed)

---

### YouTube Chat Migration to Masterchat
**Priority:** Medium

Replaced YouTube Data API polling with the `masterchat` library to avoid quota limits.

**What was done:**
- Installed `masterchat`
- Created `YouTubeMasterchat` bridge in `services/chat/bridges/YouTubeMasterchat.ts`
- Updated `ConnectionManager` to use the new bridge (no OAuth token handling)
- Updated `/api/chat/connect` to accept `videoId` instead of `liveChatId`
- Updated dashboard UI to accept video ID or URL (no OAuth link)
- Renamed config field `liveChatId` -> `youtubeVideoId`
- Updated widget URL generator and config forms
- Updated AGENTS.md documentation

**Cleanup (legacy removed):**
- `app/api/youtube/auth/route.ts`
- `app/api/youtube/callback/route.ts`
- `app/api/youtube/live-chat-id/route.ts`
- `services/chat/bridges/YouTubePoller.ts`
- `features/chat/utils/youtubeTokenStore.ts`
- Updated `features/chat/index.ts` barrel export

**Benefits:**
- No API quota consumed
- No OAuth required (video ID or URL only)
- Real-time messages (faster than polling)

---

### Chat Widget Layout & Animation Enhancements
**Priority:** Medium

Added flexible message layouts, alignment, and entrance animations for chat widgets.

**Message Layout Options:**
- `inline` - Two-column flex layout (name in column 1, message in column 2)
- `inline-wrap` - Name and message wrap together naturally
- `stacked` - Name on top, message below

**Animations (8 options):**
- `none`, `fade`, `slide-left`, `slide-right`, `slide-up`, `slide-down`, `scale`, `bounce`

**Text Alignment:**
- `left`, `center`, `right` for all layouts

**Username Display Fixes:**
- Removed `@` prefix from Discord and YouTube usernames
- Added consistent username colors via `lib/chat/usernameColor.ts`

**Files touched:**
- `features/chat/components/ChatMessage.tsx`
- `features/widgets/components/ChatWidgetConfigForm.tsx`
- `features/preferences/types.ts`
- `features/config/types.ts`
- `services/widgets/urlGenerator.ts`
- `app/widgets/chat/page.tsx`
- `app/globals.css`
- `services/chat/bridges/DiscordBridge.ts`
- `services/chat/bridges/YouTubeMasterchat.ts`
- `lib/chat/usernameColor.ts`

---

### Widget Preview in Dashboard
**Priority:** Low

Added live iframe previews to widget config cards in the dashboard.

**Features:**
- `WidgetPreview` with refresh, expand/collapse, and open-in-new-tab controls
- `WidgetConfigCard` side-by-side layout (controls left, preview right)
- Checkered transparency background (`widget-preview-bg`)
- Aspect ratio presets: "chat" (2:3), "banner" (4:1), or custom ratios
- Desktop toggle to show/hide preview
- Preview auto-updates as config changes

**Files touched:**
- `features/widgets/components/WidgetPreview.tsx`
- `features/widgets/components/WidgetConfigCard.tsx`
- `app/globals.css`

---

### Widget Config Card UX Improvements
**Priority:** Low

Small UX improvements to widget configuration cards.

**Changes:**
- Copy URL includes full host (e.g., `http://localhost:3000/widgets/chat?...`)
- Added recommended OBS browser source size per widget:
  - Chat Overlay: `400x600`
  - Follower Goal: `400x100`
  - Stream Stats: `400x100`

**Files touched:**
- `features/widgets/components/WidgetConfigCard.tsx`
- `app/dashboard/widgets/page.tsx`

---

## Architecture Decisions

1. **Feature-based architecture** - Organized code by feature domain rather than technical layer. Each feature contains its own components, hooks, types, and utils.

2. **Zustand for state management** - Chose Zustand over context providers for reduced boilerplate, better performance, and simpler mental model. Store is split into slices for organization.

3. **Services layer separation** - External API clients (TwitchIRC, YouTubePoller, DiscordBridge) moved to `services/` directory, keeping them free of React dependencies.

4. **Server-only config** - Configuration persistence logic moved to `server/` directory to clearly indicate server-only code that should not be imported by client components.

---

### Local Message Hiding
**Priority:** Medium

Added ability to hide chat messages locally (not on the actual platform). Hidden messages are still visible in the dashboard (marked as hidden) but completely filtered from the OBS widget.

**Features:**
- Hide button on message hover in dashboard
- Unhide button to restore hidden messages
- Visual indication for hidden messages (40% opacity, gray ring)
- Real-time sync via SSE hide/unhide events to all clients
- API endpoints: POST/DELETE/GET `/api/chat/hide`

**Files Created:**
- `app/api/chat/hide/route.ts` - Hide/unhide/list API endpoints
- `docs/local-message-hiding.md` - Technical design documentation

**Files Modified:**
- `features/chat/types/chat.ts` - Added `hide`/`unhide` actions, `ChatHideEvent`, updated `SSEClient`
- `services/chat/ConnectionManager.ts` - Hidden message tracking, SSE broadcast
- `features/chat/components/ChatMessage.tsx` - Hide/Unhide buttons, hidden styling
- `features/chat/components/ChatContainer.tsx` - Hide state management, event handlers
- `app/widgets/chat/page.tsx` - Filter hidden messages from display
- `app/api/chat/sse/route.ts` - Updated to use `SSEEvent` type

**Behavior:**
- Dashboard: Shows all messages; hidden ones appear dimmed with "Unhide" button
- OBS Widget: Hidden messages are completely filtered out in real-time
- State stored in-memory (resets on server restart, intentional for fresh stream starts)

---

## Session Complete
All tasks completed successfully. Active tasks tracked in `/WORKLOG.md`.
